<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Pedamint_diary</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- CSS 및 JS 라이브러리 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
    <script src="https://unpkg.com/dexie@3/dist/dexie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales/ko.global.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Batang:wght@400;700&family=Gowun+Dodum&family=Noto+Serif+KR:wght@200..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <link href="https://unpkg.com/tabulator-tables@5.5.1/dist/css/tabulator_simple.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/tabulator-tables@5.5.1/dist/js/tabulator.min.js"></script>

    <!-- Favicon -->
    <link rel="shortcut icon" href="/static/ico/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/ico/apple-touch-icon.png">
    <link rel="icon" sizes="32x32" href="/static/ico/favicon-32x32.png">
    <link rel="icon" sizes="16x16" href="/static/ico/favicon-16x16.png">
    <link rel="manifest" href="/static/ico/site.webmanifest">

    <!-- Custom CSS -->
    {% for css_file in ['style.css', 'component.css'] %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/' ~ css_file) }}">
    {% endfor %}

    <style>
        /* 셀 내용 중앙 정렬 */
        .tabulator-cell {
            text-align: center;
        }

        /* 헤더 셀 중앙 정렬 */
        .tabulator-header .tabulator-col {
            text-align: center;
        }

        /* 아이콘 버튼 스타일 */
        .icon-button {
            border: none;
            background: none;
            cursor: pointer;
            font-size: 24px;
            color: #0d6efd;
            margin-right: 10px;
        }
        .icon-button:hover {
            color: #0056b3;
        }

        /* 버튼 행 스타일 */
        .button-row {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 20px;
        }

        #drag-area {
            -webkit-app-region: drag; /* 드래그 가능 영역 설정 */
            cursor: move; /* 드래그 가능 커서 */
        }
        .navbar-nav .nav-link, .btn-group .btn {
            pointer-events: auto; /* 클릭 가능한 요소는 클릭 가능 */
        }
        .navbar-nav, .btn-group {
            -webkit-app-region: no-drag; /* 클릭 가능한 요소는 드래그 불가 */
        }

    </style>
</head>

<body>
    <div id="content" class="container-fluid">
        {% if resp %}
            <div id="top-content">
                {% include 'navbar.html' %}
            </div>
        {% else %}
        {% endif %}

        <div id="main-content">
            {% if resp %}
                <!-- PC 화면 레이아웃 -->
                <div id="pc-layout" class="d-block">
                    <div class="row m-0">
                        <div class="col-xl-9 p-2 pe-0">
                            {% include 'calendar.html' %}
                        </div>
                        <div class="col-xl-3 p-2 d-flex flex-column" style="max-height: calc(100vh - 55px);">
                            {% include 'diary.html' %}
                        </div>
                    </div>
                </div>
            {% else %}
                {% include 'hero.html' %}
            {% endif %}
        </div>
    </div>

    {% if resp %}
        <script>
            const userID = "{{ resp['email'] }}";
            const dbName = `calendarDB_${userID}`;
            const db = new Dexie(dbName);

            db.version(1).stores({ events: 'id', tabs: 'id', meta: 'key' });
            db.version(3).stores({ events: 'id', tabs: 'id', meta: 'key', diary: 'id, timestamp, *tags, isDeleted' });
            db.version(4).stores({ events: 'id', tabs: 'id', meta: 'key', diary: 'id, timestamp, *tags, isDeleted', tasks: '++id, description, completed, createdAt, updatedAt' });
            db.version(5).stores({ events: 'id', tabs: 'id', meta: 'key', diary: 'id, timestamp, *tags, isDeleted', tasks: '++id, description, completed, createdAt, updatedAt' })
                .upgrade(async (trans) => {
                    await trans.tasks.toCollection().modify(task => { task.completed = task.completed ? 1 : 0; });
                });
            db.version(6).stores({ events: 'id', tabs: 'id', meta: 'key', diary: 'id, timestamp, *tags, isDeleted', tasks: '++id, description, completed, createdAt, updatedAt, order' })
                .upgrade(async (trans) => {
                    await trans.tasks.toCollection().modify(task => { if (!task.order) task.order = 0; });
                });
            db.version(7).stores({
                events: 'id, content, *tags', // 'content'와 'tags' 추가
                tabs: 'id',
                meta: 'key',
                diary: 'id, timestamp, *tags, isDeleted',
                tasks: '++id, description, completed, createdAt, updatedAt, order'
            });
            db.version(8)
                .stores({
                    events: 'id, start, end, content, *tags', // 'start', 'end' 추가
                    tabs: 'id',
                    meta: 'key',
                    diary: 'id, timestamp, *tags, isDeleted',
                    tasks: '++id, description, completed, createdAt, updatedAt, order'
                })
                .upgrade(async (trans) => {
                    // 기존 데이터 업데이트
                    await trans.events.toCollection().modify(event => {
                        if (!event.start) event.start = new Date().toISOString(); // 기본값 설정
                        if (!event.end) event.end = new Date().toISOString();   // 기본값 설정
                        if (!Array.isArray(event.tags)) event.tags = [];         // tags 배열 초기화
                    });
                });
            // 버전 9: 'start'와 'end' 필드 제거
            db.version(9)
              .stores({
                events: 'id, content, *tags', // 'start', 'end' 제거
                tabs: 'id',
                meta: 'key',
                diary: 'id, timestamp, *tags, isDeleted',
                tasks: '++id, description, completed, createdAt, updatedAt, order'
              })
              .upgrade(async (trans) => {
                // 기존 데이터에서 'start'와 'end' 필드 제거
                await trans.events.toCollection().modify(event => {
                  delete event.start;
                  delete event.end;
                });
              });
            db.version(10).stores({
                events: 'id, content, *tags',
                tabs: 'id',
                meta: 'key',
                diary: 'id, timestamp, *tags, isDeleted',
                tasks: '++id, description, completed, createdAt, updatedAt, order',
                checklists: '++id, studentName, subject, status'
            });
        </script>
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                // Planner/Widgets 토글
                const buttons = document.querySelectorAll("[data-toggle]");
                const contents = document.querySelectorAll("[data-content]");

                buttons.forEach(button => {
                    button.addEventListener("click", function() {
                        const targetContent = button.getAttribute("data-toggle");

                        contents.forEach(content => {
                            if (content.getAttribute("data-content") === targetContent) {
                                content.style.display = "block";
                            } else {
                                content.style.display = "none";
                            }
                        });
                    });
                });
            });
        </script>

        <script src="/static/js/indexeddb.js"></script>
        <script src="/static/js/calendar.js"></script>
        <script src="/static/js/diary.js"></script>
    {% endif %}
</body>
</html>